<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Signal API</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f5f7fa;
      color: #333;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      font-size: 24px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-email {
      font-size: 14px;
      opacity: 0.9;
    }

    .btn-logout {
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 6px;
      text-decoration: none;
      font-size: 14px;
      transition: background 0.3s;
    }

    .btn-logout:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .stat-card h3 {
      color: #666;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      font-size: 36px;
      font-weight: 700;
      color: #667eea;
    }

    .filters {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
    }

    .filters h2 {
      margin-bottom: 20px;
      color: #333;
      font-size: 18px;
    }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 6px;
      color: #555;
    }

    .form-group input {
      padding: 10px 12px;
      border: 2px solid #e1e8ed;
      border-radius: 6px;
      font-size: 14px;
    }

    .form-group input:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
    }

    .btn-secondary {
      background: #e1e8ed;
      color: #333;
    }

    .btn-secondary:hover {
      background: #d1d8dd;
    }

    .messages-table {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      overflow: hidden;
    }

    .table-header {
      padding: 20px 25px;
      border-bottom: 2px solid #f0f0f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .table-header h2 {
      font-size: 18px;
      color: #333;
    }

    .table-info {
      font-size: 14px;
      color: #666;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: #f8f9fa;
    }

    th {
      padding: 15px 20px;
      text-align: left;
      font-size: 13px;
      font-weight: 600;
      color: #555;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    td {
      padding: 15px 20px;
      border-top: 1px solid #f0f0f0;
      font-size: 14px;
    }

    tbody tr:hover {
      background: #f8f9fa;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-sent {
      background: #d4edda;
      color: #155724;
    }

    .status-failed {
      background: #f8d7da;
      color: #721c24;
    }

    .message-text {
      max-width: 400px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .no-data {
      text-align: center;
      padding: 60px 20px;
      color: #999;
      font-size: 16px;
    }

    /* Signal Connection Styles */
    .signal-connection {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
    }

    .signal-connection h2 {
      margin-bottom: 15px;
      color: #333;
      font-size: 18px;
    }

    .signal-status {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
    }

    .status-connected {
      background: #d4edda;
      color: #155724;
    }

    .status-disconnected {
      background: #f8d7da;
      color: #721c24;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .status-connected .status-dot {
      background: #28a745;
    }

    .status-disconnected .status-dot {
      background: #dc3545;
    }

    .btn-signal {
      background: linear-gradient(135deg, #3a76f0 0%, #2958c4 100%);
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .btn-signal:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(58, 118, 240, 0.4);
    }

    .btn-signal:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* Modal Styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: white;
      padding: 30px;
      border-radius: 16px;
      max-width: 400px;
      width: 90%;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal h3 {
      margin-bottom: 10px;
      color: #333;
      font-size: 20px;
    }

    .modal p {
      color: #666;
      margin-bottom: 20px;
      font-size: 14px;
      line-height: 1.5;
    }

    .qr-container {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .qr-container img {
      max-width: 250px;
      width: 100%;
      height: auto;
    }

    .qr-loading {
      padding: 40px;
      color: #666;
    }

    .qr-error {
      padding: 20px;
      color: #dc3545;
      background: #f8d7da;
      border-radius: 8px;
    }

    .modal-close {
      background: #e1e8ed;
      color: #333;
      padding: 10px 30px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .modal-close:hover {
      background: #d1d8dd;
    }

    .signal-info {
      background: #e7f3ff;
      border-left: 4px solid #3a76f0;
      padding: 12px 16px;
      border-radius: 0 8px 8px 0;
      margin-top: 15px;
      font-size: 13px;
      color: #1a4d8c;
    }

    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }

      .filter-grid {
        grid-template-columns: 1fr;
      }

      table {
        font-size: 12px;
      }

      th, td {
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üìä Signal API Dashboard</h1>
    <div class="user-info">
      <span class="user-email"><%= admin.adminEmail %></span>
      <a href="/admin/logout" class="btn-logout">Logout</a>
    </div>
  </div>

  <div class="container">
    <!-- Statistics -->
    <div class="stats-grid">
      <div class="stat-card">
        <h3>Total Messages</h3>
        <div class="stat-value" id="totalMessages"><%= stats.total || 0 %></div>
      </div>
      <div class="stat-card">
        <h3>Unique Recipients</h3>
        <div class="stat-value" id="uniqueRecipients"><%= stats.unique || 0 %></div>
      </div>
      <div class="stat-card">
        <h3>Today's Messages</h3>
        <div class="stat-value" id="todayMessages">0</div>
      </div>
    </div>

    <!-- Signal Connection -->
    <div class="signal-connection">
      <h2>üì± Signal Connection</h2>
      <div class="signal-status">
        <div id="signalStatus" class="status-indicator status-disconnected">
          <span class="status-dot"></span>
          <span id="signalStatusText">Checking...</span>
        </div>
        <button class="btn-signal" id="connectSignalBtn" onclick="showQRCode()">
          üîó Connect Signal App
        </button>
        <button class="btn btn-secondary" onclick="checkSignalStatus()">
          üîÑ Refresh Status
        </button>
      </div>
      <div class="signal-info">
        <strong>üí° Tip:</strong> Click "Connect Signal App" to display a QR code. Open Signal on your phone ‚Üí Settings ‚Üí Linked Devices ‚Üí Link New Device ‚Üí Scan the QR code.
      </div>
    </div>

    <!-- QR Code Modal -->
    <div class="modal-overlay" id="qrModal">
      <div class="modal">
        <h3>üì± Link Signal App</h3>
        <p>Open Signal on your phone, go to <strong>Settings ‚Üí Linked Devices ‚Üí Link New Device</strong>, then scan this QR code:</p>
        <div class="qr-container" id="qrContainer">
          <div class="qr-loading">Loading QR code...</div>
        </div>
        <button class="modal-close" onclick="closeQRModal()">Close</button>
      </div>
    </div>

    <!-- Filters -->
    <div class="filters">
      <h2>üîç Filter Messages</h2>
      <div class="filter-grid">
        <div class="form-group">
          <label for="phoneFilter">Phone Number</label>
          <input type="text" id="phoneFilter" placeholder="+1234567890">
        </div>
        <div class="form-group">
          <label for="dateFilter">Specific Date</label>
          <input type="date" id="dateFilter">
        </div>
        <div class="form-group">
          <label for="startDateFilter">Start Date</label>
          <input type="date" id="startDateFilter">
        </div>
        <div class="form-group">
          <label for="endDateFilter">End Date</label>
          <input type="date" id="endDateFilter">
        </div>
      </div>
      <div class="btn-group">
        <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
        <button class="btn btn-secondary" onclick="clearFilters()">Clear Filters</button>
        <button class="btn btn-secondary" onclick="exportData()">Export CSV</button>
      </div>
    </div>

    <!-- Messages Table -->
    <div class="messages-table">
      <div class="table-header">
        <h2>üì® Messages History</h2>
        <span class="table-info" id="tableInfo">Loading...</span>
      </div>
      <div id="tableContainer">
        <div class="loading">Loading messages...</div>
      </div>
    </div>
  </div>

  <script>
    let allMessages = [];

    // Load messages on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadMessages();
      checkSignalStatus();
    });

    // Signal Connection Functions
    async function checkSignalStatus() {
      const statusEl = document.getElementById('signalStatus');
      const statusText = document.getElementById('signalStatusText');
      const connectBtn = document.getElementById('connectSignalBtn');
      
      try {
        const response = await fetch('/admin/api/signal/status');
        const data = await response.json();
        
        if (data.success && data.connected) {
          statusEl.className = 'status-indicator status-connected';
          statusText.textContent = 'Connected';
          connectBtn.textContent = '‚úÖ Signal Connected';
        } else {
          statusEl.className = 'status-indicator status-disconnected';
          statusText.textContent = 'Not Connected';
          connectBtn.textContent = 'üîó Connect Signal App';
        }
      } catch (error) {
        console.error('Error checking Signal status:', error);
        statusEl.className = 'status-indicator status-disconnected';
        statusText.textContent = 'Unable to check';
      }
    }

    async function showQRCode() {
      const modal = document.getElementById('qrModal');
      const container = document.getElementById('qrContainer');
      
      modal.classList.add('active');
      container.innerHTML = '<div class="qr-loading">‚è≥ Generating QR code...</div>';
      
      try {
        const response = await fetch('/admin/api/signal/qrcode');
        const data = await response.json();
        
        if (data.success) {
          container.innerHTML = `<img src="${data.qrCode}" alt="Signal QR Code" />`;
        } else {
          container.innerHTML = `<div class="qr-error">‚ùå ${data.error}</div>`;
        }
      } catch (error) {
        console.error('Error getting QR code:', error);
        container.innerHTML = '<div class="qr-error">‚ùå Failed to generate QR code. Make sure Signal CLI is running.</div>';
      }
    }

    function closeQRModal() {
      document.getElementById('qrModal').classList.remove('active');
      // Refresh status after closing modal
      setTimeout(checkSignalStatus, 1000);
    }

    // Close modal when clicking outside
    document.getElementById('qrModal').addEventListener('click', (e) => {
      if (e.target.id === 'qrModal') {
        closeQRModal();
      }
    });

    async function loadMessages(filters = {}) {
      try {
        const params = new URLSearchParams(filters);
        const response = await fetch(`/admin/api/messages?${params}`);
        const data = await response.json();

        if (data.success) {
          allMessages = data.messages;
          renderTable(data.messages, data.total);
          updateTodayCount(data.messages);
        } else {
          showError('Failed to load messages');
        }
      } catch (error) {
        console.error('Error loading messages:', error);
        showError('Error loading messages');
      }
    }

    function renderTable(messages, total) {
      const container = document.getElementById('tableContainer');
      document.getElementById('tableInfo').textContent = `Total: ${total} messages`;

      if (messages.length === 0) {
        container.innerHTML = '<div class="no-data">No messages found</div>';
        return;
      }

      const html = `
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Phone Number</th>
              <th>Message</th>
              <th>Status</th>
              <th>Date & Time</th>
            </tr>
          </thead>
          <tbody>
            ${messages.map(msg => `
              <tr>
                <td>${msg.id}</td>
                <td>${msg.phone_number}</td>
                <td><div class="message-text" title="${escapeHtml(msg.message)}">${escapeHtml(msg.message)}</div></td>
                <td><span class="status-badge status-${msg.status}">${msg.status}</span></td>
                <td>${formatDate(msg.created_at)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;

      container.innerHTML = html;
    }

    function applyFilters() {
      const filters = {};
      
      const phone = document.getElementById('phoneFilter').value.trim();
      const date = document.getElementById('dateFilter').value;
      const startDate = document.getElementById('startDateFilter').value;
      const endDate = document.getElementById('endDateFilter').value;

      if (phone) filters.phone_number = phone;
      if (date) filters.date = date;
      if (startDate && endDate) {
        filters.start_date = startDate;
        filters.end_date = endDate;
      }

      loadMessages(filters);
    }

    function clearFilters() {
      document.getElementById('phoneFilter').value = '';
      document.getElementById('dateFilter').value = '';
      document.getElementById('startDateFilter').value = '';
      document.getElementById('endDateFilter').value = '';
      loadMessages();
    }

    function updateTodayCount(messages) {
      const today = new Date().toISOString().split('T')[0];
      const todayCount = messages.filter(msg => {
        const msgDate = new Date(msg.created_at).toISOString().split('T')[0];
        return msgDate === today;
      }).length;
      document.getElementById('todayMessages').textContent = todayCount;
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleString();
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function exportData() {
      if (allMessages.length === 0) {
        alert('No data to export');
        return;
      }

      const csv = [
        ['ID', 'Phone Number', 'Message', 'Status', 'Date & Time'],
        ...allMessages.map(msg => [
          msg.id,
          msg.phone_number,
          msg.message.replace(/"/g, '""'),
          msg.status,
          formatDate(msg.created_at)
        ])
      ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `signal-messages-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
    }

    function showError(message) {
      document.getElementById('tableContainer').innerHTML = 
        `<div class="no-data" style="color: #c33;">${message}</div>`;
    }
  </script>
</body>
</html>
